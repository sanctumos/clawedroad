# EVM and Payments Plan

**Binding decisions:** See **08-PLANNING-DECISIONS-QA.md** (tokens admin-configurable, Alchemy-supported only, chains mainnet/Sepolia/Base, HD-derived escrow, Alchemy for MVP, roadmap decentralize).

## 1. Target: EVM Only

- **Drop**: All Bitcoin (BTC) support: addresses, wallets, transactions, multisig, Payaka BTC endpoints, cron for BTC wallets/transactions.
- **Keep conceptually**: Escrow flow, commission, referral (buyer only in MVP; vendor referral on roadmap), dispute splits — but only in **EVM** terms (ETH + admin-configurable ERC‑20 tokens). **Single-key escrow** in MVP; multisig (e.g. Gnosis Safe) on roadmap.

## 2. Payment Methods

- **Native ETH**: Pay and receive in ETH.
- **Tokens**: **Admin-configurable** in admin panel. Must be **Alchemy-supported**; if API returns “not found” or “no price data” for a configured token, **fail** (do not allow that token). One or more contract addresses (or symbols) in config; Alchemy used to read balance and send.

## 3. Alchemy API Usage

- **Current**: Ethereum (and Bitcoin) go through an external **PaymentGate** (Payaka): `APPLICATION_SETTINGS.PaymentGate` (e.g. `http://127.0.0.1:8083`). Calls like:
  - `GET/POST .../ethereum/wallets/new` → generate address
  - `GET .../ethereum/wallets/{address}` → balance
  - `POST .../ethereum/wallets/{address}/send` → send with payments array (address + percent or amount).
- **Target**: Use **Alchemy API** (or Alchemy SDK) for EVM access (MVP; roadmap: more decentralized architecture):
  - **Address generation**: **HD-derived escrow keys from a single mnemonic** in the **Python** service (one mnemonic → infinite deterministic escrow addresses). Never expose keys to PHP.
  - **Balance**: Alchemy `eth_getBalance` (+ token balance for ERC‑20). If token not found or no price data → fail.
  - **Send**: Build and sign tx in Python; broadcast via Alchemy `eth_sendRawTransaction`.

Key material and signing only in Python; PHP records results in DB (SQLite MVP / MariaDB prod).

## 4. Escrow Addresses

- **Current**: One escrow address per transaction (UUID = address for ETH/BTC). Generated by PaymentGate `GenerateETHAddress("escrow")`.
- **Target**: One EVM address per transaction. **HD-derived** from single mnemonic in Python (BIP-32/44); address and chain_id stored in DB. For tokens, same address; balance tracked per (address, contract). Mnemonic in .env; never in DB or PHP.

**Binding flow (see [05-ARCHITECTURE-LEMP-PYTHON.md](05-ARCHITECTURE-LEMP-PYTHON.md) §8):** PHP creates the transaction **without** an escrow address (metadata only); PHP shows "Escrow address pending — may take up to 60 seconds." Python (cron) is the **only** component that derives the address; on each run it finds transactions missing an escrow address, derives it, writes it to the EVM/escrow record, and inserts the first `transaction_status` row (e.g. PENDING, "Escrow address created"). PHP then displays `escrow_address` once present (and QR if desired). Users/agents accept up to ~60s delay before the address appears.

## 5. Transaction Type in DB

- **Current**: `Transaction.Type` = `bitcoin` | `ethereum`; separate `BitcoinTransaction` / `EthereumTransaction` tables with amount (in BTC/ETH).
- **Target**: Single EVM flow: e.g. `Transaction.Type` = `ethereum` or `evm`, and one table (e.g. `evm_transactions` or reuse `ethereum_transactions`) with:
  - `uuid` (escrow address),
  - `amount` (numeric),
  - `currency` (e.g. `ETH` or token contract address / symbol),
  - optional `chain_id` if multi-chain.

Accounting spec (01) still applies: same status machine, completion threshold, release/cancel/partial-refund splits; only the “send” and “balance” calls go through Alchemy (in Python).

## 6. Currency and Price

- **Current**: `PackagePrice` in one currency (e.g. USD); `GetPrice(currency)` converts via `GetCurrencyRate(base, target)`. Rates from external API (`apis.GetCurrencyRates`).
- **Target (08)**: **One base: USD**. Vendors set listing prices in USD. At checkout/display, convert to ETH/token using **Alchemy Prices API** (REST, not on-chain oracle):
  - **ETH/USD**: `GET /prices/v1/tokens/by-symbol?symbols=ETH` (Authorization: Bearer `ALCHEMY_KEY`); use `data[0].prices` where `currency === "USD"`.
  - **ERC-20/USD**: `POST /prices/v1/<API_KEY>/tokens/by-address` with `addresses: [{ network, address }]`; response includes USD price per token. Use for admin-configured tokens (by contract address).
  Alchemy Prices API aggregates CEX + DEX data; no on-chain oracle required. **Optional fallback**: If Alchemy pricing is unavailable or incomplete, use **CoinGecko** (or similar) as secondary source. Schema: e.g. `package_prices` in USD; conversion to crypto at runtime via Prices API (Python cron or PHP can cache).

## 7. Commission and Referral (EVM)

- **Current ETH**: Vendor gets `(1 - commission)`; buyer inviter gets `commission * inviterPercent`; remainder to `EthereumCommissionWallet`.
- **Target**: Same split logic; all payouts in ETH (or in same token as the transaction). Commission wallet and inviter addresses must be EVM (0x...). Python service performs multi-recipient send (or multiple txs) so percents sum to 1.0.

## 8. User Wallets (Buyer Funding) — MVP: External Only (08)

- **Current (v1 reference)**: User has Ethereum (and Bitcoin) wallets; balance from PaymentGate; fund-from-wallet sends from user wallet to escrow for “fund from wallet”.
- **MVP (08)**: **Buyer sends from external wallet only.** No in-app buyer wallets; no fund-from-wallet in MVP. Show escrow address (and optional QR); buyer pays from their own wallet (MetaMask, etc.). No “fund from user wallet”; Do **not** implement buyer hot wallets or FundFromUserWallets in MVP. **Roadmap**: In-app user wallets and fund-from-wallet can be added later.

## 9. Deposits (Vendor)

- **Current**: Deposit = store + fiat value + crypto (BTC/ETH) + address + crypto value. Withdraw = send from deposit address to store admin wallet.
- **Target**: EVM only: deposit address holds ETH (and optionally token). Balance and withdraw in Python via Alchemy.

## 10. Config (EVM)

- **Remove**: `PaymentGate` (Payaka), Bitcoin-related settings, multisig settings.
- **Add**: `.env` for secrets. `alchemy_api_key`, `alchemy_network` (mainnet / Sepolia / Base). **Commission wallet: one per chain**, set in **.env** (e.g. `COMMISSION_WALLET_MAINNET`, `COMMISSION_WALLET_SEPOLIA`, `COMMISSION_WALLET_BASE`). **Accepted tokens** (admin-configurable; list of Alchemy-supported contract addresses or symbols). **Chains**: **Mainnet**, **Sepolia** (staging), **Base** only. Separate Alchemy account for prod; decentralize on roadmap.

## 11. Files to Retire (Go) / Replace in New Stack

- **Remove**: `modules/apis/payments_bitcoin.go`, all `*bitcoin*` in marketplace (models, views, tasks, router).
- **Use as reference**: `modules/apis/payments_ethereum.go` (replace HTTP PaymentGate with Alchemy in Python); `models_transaction_cc_ethereum.go` (split logic); `models_wallet_ethereum.go` (balance/send pattern).

Python service should implement (MVP): address generation, balance (ETH + token), send (single and multi-recipient). PHP/DB contract: “create escrow”, “get balance”, “release”, “cancel”, “partial refund”, “withdraw deposit”. **Not in MVP:** “send from user wallet” (08: buyer sends from external wallet only).
